
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>공사진행 관리</title>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f17;
      --card: #111827;
      --line: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --brand: #38bdf8;
      --brand-2: #60a5fa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing: border-box; }
/* === Android/Chrome: pull-to-refresh 차단(권장 설정) === */
html, body{
  height: 100%;
  overscroll-behavior-y: contain;   /* 새로고침 트리거 차단 */
}

/* 내부 스크롤 컨테이너도 체이닝 방지 */
.wrap, .main, .side, .right{
  overscroll-behavior: contain;
}
    body{
      margin:0; background: radial-gradient(1200px 600px at 20% -10%, rgba(56,189,248,.12), transparent 60%),
                               radial-gradient(900px 500px at 100% 0%, rgba(96,165,250,.10), transparent 60%),
                               var(--bg);
      font-family: "Nanum Gothic", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
    }

    /* ---------- Auth Layout ---------- */
    .center { min-height: 100dvh; display: grid; place-items: center; padding: 24px; }
    .card{
      width: 100%; max-width: 880px; background: linear-gradient(180deg,#0f172a 0%, #0b1220 100%);
      border: 1px solid #1f2a3a; border-radius: var(--radius); box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .head{
      display:flex; align-items:center; gap:14px; padding:22px 26px; border-bottom:1px solid var(--line);
      background: linear-gradient(90deg, rgba(56,189,248,.15), transparent);
    }
    .logo{ width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--brand), var(--brand-2)); display:grid; place-items:center; font-weight:800; color:#0b0f17; }
    .title{ font-size: 18px; font-weight: 800; letter-spacing:.3px }
    .body{ padding: 22px 26px 26px 26px; }
    .auth-grid{ display:grid; grid-template-columns: 1fr; gap: 24px; } /* 안내 패널 제거 */
    .panel{ background: #0b1220; border:1px solid var(--line); border-radius: 14px; padding: 18px; }
    .panel h3{ margin:0 0 12px 0; font-size: 15px; color:#c7d2fe; }

    label{ display:block; font-size: 12px; color: var(--muted); margin: 8px 0 6px; }
    input[type="text"], input[type="password"], input[type="number"], input[type="search"]{
      width:100%; padding: 12px 12px; background:#0a1323; color:var(--text); border:1px solid #1f2a3a; border-radius: 10px;
      outline:none; transition: border-color .2s ease;
    }
    input:focus{ border-color: var(--brand); }
    textarea{
  width:100%;
  background:#0a1323;
  color:var(--text);
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  min-height: 220px;  /* ✅ 메모 칸 세로 크기 크게 */
}

    .row{ display:flex; gap:10px; flex-wrap: wrap; }
    .btn{
      appearance:none; border:none; cursor:pointer; padding: 11px 14px; border-radius: 10px; font-weight:700;
      color:#0b0f17; background: linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: 0 8px 18px rgba(56,189,248,.2);
    }
    .btn.secondary{ background:#0a1323; color: var(--text); border:1px solid var(--line); box-shadow:none; }
    .btn.warn{ background: linear-gradient(135deg, #f97316, #f59e0b); color:#0b0f17 }
    .btn.ghost{ background: transparent; color: var(--muted); border:1px dashed #233044; }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    .helper{ font-size:12px; color: var(--muted); margin-top: 8px; }
    .sep{ height:1px; background: var(--line); margin: 18px 0; }
    .link{ color: #93c5fd; text-decoration: underline; cursor:pointer }
    .note{ font-size: 12px; color: #9ca3af; background:#0a1323; border:1px solid var(--line); border-radius: 10px; padding: 10px; }

    /* ---------- App Layout ---------- */
    .app{ display:none; min-height: 100dvh; grid-template-rows: auto 1fr; gap: 0; padding: 0; }
    .topbar{
      position: sticky; top:0; z-index: 5; display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding: 14px 18px; border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.65)); backdrop-filter: blur(8px);
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand .logo{ width:28px; height:28px; font-size: 14px; }
    .brand .product{ font-weight:800; font-size: 15px; }
.site-select{ background:#0a1323; color:var(--text); border:1px solid #1f2a3a; border-radius:10px; padding:8px 10px; }
    .tabs{ display:flex; gap:8px; }
    .tab{ padding: 8px 12px; border-radius: 10px; border:1px solid var(--line); color: var(--muted); cursor:pointer; user-select:none; }
    .tab.active{ color: var(--text); border-color: #2a3c56; background: #0a1323; }

.site-add-btn{
  background:#0a1323; color:var(--text); border:1px solid #1f2a3a; border-radius:10px;
  padding:8px 10px; margin-left:8px; cursor:pointer;
}
.site-add-btn:hover{ border-color:#2a3c56; }

    .userbox{ display:flex; align-items:center; gap:10px; }
    .role-badge{ font-size: 11px; padding: 4px 8px; border-radius: 999px; background: #10213a; color: #9cc7ff; border:1px solid #274a76; }

    .wrap{ display:grid; grid-template-columns: 240px 1fr 320px; gap: 18px; padding: 18px; }
    @media (max-width: 1100px){ .wrap{ grid-template-columns: 220px 1fr; } .right{ display:none } }

    .side, .main, .right{ background:#0b1220; border:1px solid var(--line); border-radius: var(--radius); }
    .side{ padding: 14px; }
    .side h4{ margin:0 0 10px 0; color:#c7d2fe; font-size: 14px; }
    .cat{ display:flex; flex-direction:column; gap: 8px; }
    .cat button{ text-align:left; width:100%; background:#0a1323; border:1px solid #1e2a3c; color:var(--text); border-radius: 12px; padding: 10px 12px; cursor:pointer; }
    .cat button.active{ border-color:#30507a; background:#0f1b2c; }

    .main{ padding: 14px; }
    .section-title{ display:flex; align-items:center; justify-content:space-between; margin: 2px 0 12px 0; flex-wrap: wrap; gap: 10px; }
    .section-title h2{ margin:0; font-size: 18px; }
    .hint{ font-size: 12px; color:var(--muted); }

    .grid{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 14px; }
    @media (max-width: 1200px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px){ .grid{ grid-template-columns: 1fr; } }

    .item-card{ background:#091120; border:1px solid #1b2637; border-radius: 14px; overflow: hidden; display:flex; flex-direction:column; }
    .placeholder{ font-size:12px; color: #546582; }
    .item-body{ padding: 10px 12px; display:flex; flex-direction:column; gap: 6px; }
    .item-title{ font-weight: 700; }
.item-name{ font-weight: 400; }
    .mini{ font-size: 12px; color: var(--muted); }

    .admin-controls{ display:none; gap: 8px; }
    .admin-controls.visible{ display:flex; flex-wrap:wrap; }

    .right{ padding: 14px; }
    .right h3{ margin: 0 0 10px 0; font-size: 15px; color:#c7d2fe; }

    table{ width:100%; border-collapse: collapse; }
    th, td{ text-align:left; padding: 10px 8px; border-bottom:1px solid #1d293a; font-size: 13px; }
    th{ color:#9cc7ff; font-weight: 700; }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .toast{ position: fixed; right: 14px; bottom: 14px; background:#111827; border:1px solid #2a3c56; padding:10px 12px; border-radius: 10px; box-shadow: var(--shadow); display:none }
    .empty{ padding: 18px; color: var(--muted); font-size: 13px; text-align:center; border:1px dashed #2a3c56; border-radius: 12px; }
    .ribbon{ font-size: 11px; color: #93c5fd; }
    .badge{ display:inline-flex; align-items:center; gap:7px; font-size:12px; color:var(--muted) }
    .hidden{ display:none !important }

    /* Modal */
/* Modal (항상 Topbar 위로) */
.modal{
  position: fixed;
  inset: 0;
  display: none;
  z-index: 10050;                 /* ★ Topbar(5), 칩바(4), 로딩(9999)보다 위 */
}
.modal .backdrop{
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(2px);
  z-index: 0;
}
.modal .dialog{
  position: relative;
  z-index: 1;
  margin: 10dvh auto;             /* 모바일에서 상단 여유를 조금 더 */
  max-width: 560px;
  background: #0b1220;
  border: 1px solid var(--line);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

/* 모바일일 때는 여유를 더 주고 화면 폭에 맞춤 */
@media (max-width: 720px){
  .modal .dialog{
    margin: 12dvh auto;           /* ★ 상단 고정바를 확실히 넘어오게 */
    max-width: 94vw;              /* 좌우 여백 확보 */
  }
}
    .modal .dialog .hd{ display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; border-bottom:1px solid var(--line) }
    .modal .dialog .bd{ padding: 16px }

/* === Big Image Viewer === */
#modalImage .dialog{
  max-width: min(96vw, 1200px);
}
#modalImage .img-wrap{
  background:#000; 
  display:grid; 
  place-items:center; 
  border-radius:12px; 
  overflow:hidden;
}
#modalImage .img-wrap img{
  max-width: 90vw; 
  max-height: 80vh; 
  width:auto; 
  height:auto; 
  display:block;
}

/* 이미지 뷰어 안의 큰 이미지 위 커서 */
#modalImage .img-wrap img { cursor: zoom-out; }
#modalImage .img-caption{
  font-size:12px; 
  color:var(--muted); 
  margin-top:8px; 
  text-align:center;
}

    .spinner{ width: 16px; height: 16px; border:2px solid #274a76; border-top-color: #93c5fd; border-radius: 50%; animation: spin .8s linear infinite; display:inline-block }
    @keyframes spin{ to{ transform: rotate(360deg) } }

/* ======== Loading Overlay ======== */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-box {
  text-align: center;
  background: rgba(15,23,42,0.85);
  border: 1px solid #334155;
  border-radius: 16px;
  padding: 24px 32px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
}

.spinner.lg {
  width: 42px;
  height: 42px;
  border: 4px solid #3b82f6;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: inline-block;
  margin-bottom: 12px;
}

.loading-text {
  color: #93c5fd;
  font-size: 15px;
  font-weight: 600;
}

.site-tags{display:flex;flex-wrap:wrap;gap:6px}
.site-tag{background:#1f2937;border:1px solid #334155;border-radius:999px;padding:2px 8px;display:inline-flex;align-items:center;font-size:12px}
.site-tag button{border:0;background:transparent;margin-left:6px;cursor:pointer;color:#9ca3af}
.grant-row{display:flex;gap:8px;align-items:center}
.grant-row select{min-width:180px}

/* ======= Mobile Optimizations (≤ 720px) — with Sticky Category Chips ======= */
@media (max-width: 720px){

  /* Topbar: 줄바꿈 + 간격 축소 */
  .topbar{
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px 12px;
  }
  .brand .product{ font-size: 14px; }
  #envRibbon{ display:none !important; }

  /* 드롭박스/추가 버튼: 한 줄씩 100% */
  .site-select{
    width: 100% !important;
    margin-top: 6px;
    padding: 10px 12px;
  }
  .site-add-btn{
    width: 100% !important;
    margin: 6px 0 0 0;
    padding: 10px 12px;
  }

  /* 탭: 가로 스크롤 가능 */
  .tabs{
    order: 3;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    gap: 6px;
  }
  .tab{
    flex: 0 0 auto;
    padding: 8px 10px;
    font-size: 13px;
  }

  /* 메인 레이아웃: 1열 스택 */
  .wrap{
    grid-template-columns: 1fr !important;
    gap: 12px;
    padding: 12px;
  }

  /* === 사이드바 카테고리는 모바일에서 숨김, 대신 칩 바 사용 === */
  .side{ display: none !important; }

  /* 모바일용 카테고리 칩 바 (sticky) */
  .cat-chips-wrap{
    display: block !important;
    position: sticky;
    top: 56px;                  /* 탑바 높이에 맞춰 필요시 조정 */
    z-index: 4;
    padding: 8px 12px;
    margin: -6px -12px 6px -12px; /* 메인 패딩과 자연스럽게 잇기 */
    background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.78));
    border-bottom: 1px solid var(--line);
    backdrop-filter: blur(6px);
  }
  .cat-chips{
    display: flex;
    gap: 8px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2px;
  }
  .cat-chip{
    flex: 0 0 auto;
    border: 1px solid #263347;
    background: #0a1323;
    color: var(--text);
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 14px;
    line-height: 1;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  .cat-chip.active{
    border-color: #3b82f6;
    background: linear-gradient(135deg, var(--brand), var(--brand-2));
    color: #07111d;
    font-weight: 800;
  }

  /* 오른쪽 패널(메모)도 보이게 */
  .right{
    display: block !important;
    margin-top: 4px;
    padding: 12px;
  }

  /* 카드 그리드: 2칸 */
  .grid{
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 10px !important;
  }

  /* 썸네일(선택): 정사각형으로 보려면 주석 해제
  .item-thumb{ aspect-ratio: 1 / 1; }
  */

  /* 카드/입력 UI 터치 최적화 */
  .item-card{ border-radius: 12px; }
  .item-body{ padding: 10px; }
  input[type="text"], input[type="password"], input[type="number"], input[type="search"], textarea{
    padding: 10px 12px;
    font-size: 14px;
  }
  .btn{
    padding: 10px 12px;
    border-radius: 10px;
    font-size: 14px;
  }

  /* 섹션 타이틀 여백 축소 */
  .section-title{
    margin: 0 0 10px 0;
    gap: 8px;
  }
  .section-title h2{ font-size: 16px; }

  /* 모달: 화면에 맞게 */
  .modal .dialog{
    margin: 6dvh auto;
    max-width: 94vw !important;
  }
  #modalImage .dialog{
    max-width: 96vw !important;
  }
  #modalImage .img-wrap img{
    max-width: 94vw;
    max-height: 70vh;
  }

  /* Users 테이블: 좌우 스크롤 허용 */
  .admin-table{
    display: block;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-spacing: 0;
  }

  /* 토스트 위치 */
  .toast{
    right: 10px;
    bottom: 10px;
  }
}

#app, #auth { overscroll-behavior-y: none; }

/* ===== 모바일 가시성/안정성 패치 ===== */

/* iOS 자동 폰트확대/줌 방지 */
html {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

/* 이미지가 카드 밖으로 튀거나 줄을 밀지 않게 고정 */
img { 
  display: block;
  max-width: 100%;
  height: auto;
}

/* 카드 내부 레이아웃 안정화 */
.item-card{
  display: flex;
  flex-direction: column;
  overflow: hidden;             /* 겹침 방지 */
  contain: content;             /* 페인트 영역 고정(모바일 레이아웃 튐 감소) */
}
.item-thumb{
  position: relative;
  aspect-ratio: 1 / 1;        /* 고정 비율로 높이 확보 → 로딩 중에도 레이아웃 안 튐 */
  background:#0a1323;
  border-bottom:1px solid #1b2637;
  overflow: hidden;             /* 이미지 넘침 차단 */
}
.item-thumb img{
  width:100%;
  height:100%;
  object-fit: contain;          /* ★ 전부 보이게 */
  display:block;
}

/* 제목/이름이 길 때 줄바꿈 강제 (기기별 한글/영문 혼합 케이스 대응) */
.item-title,
.item-name {
  line-height: 1.35;
  word-break: break-word;       /* 한글/영문 공통 자동 줄바꿈 */
  overflow-wrap: anywhere;      /* 긴 토큰(연속숫자/URL 등)도 강제 줄바꿈 */
}

/* 날짜 라인도 겹침 방지 */
.mini { 
  line-height: 1.3;
  white-space: normal;
}

/* 모바일 카드 간격과 패딩 미세 조정 (가시성) */
@media (max-width: 600px){
  .grid{ gap: 10px; }
  .item-body{ padding: 10px; }
  .section-title h2{ font-size: 16px; }
}
  </style>
</head>
<body>
  <!-- =================== AUTH =================== -->
  <section id="auth" class="center">
    <div class="card">
      <div class="head">
        <div class="logo">M</div>
        <div>
          <div class="title">공사진행 관리</div>
          <!-- 부제 삭제 -->
        </div>
      </div>
      <div class="body">
        <div class="auth-grid">
          <div class="panel">
            <h3>로그인</h3>
            <label for="loginId">아이디</label>
            <input id="loginId" type="text" autocomplete="username" placeholder="your_id" />
            <label for="loginPw">비밀번호</label>
            <input id="loginPw" type="password" autocomplete="current-password" placeholder="••••••••" />
            <div class="row" style="margin-top:12px">
              <button id="btnLogin" class="btn">로그인</button>
              <button id="btnOpenSignup" class="btn ghost">가입하기</button>
            </div>
            <div id="authMsg" class="helper"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- =================== APP =================== -->
  <section id="app" class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">M</div>
        <div class="product">공사진행 관리</div>

<select id="siteSelect" class="site-select" aria-label="현장 선택">
    <option value="">전체 현장</option>
  </select>
<button type="button" id="btnSiteAdd" class="site-add-btn hidden">추가</button>

        <div id="envRibbon" class="ribbon hidden"></div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="materials">선택한 마감재</div>
        <div class="tab" data-tab="progress">공사 진행사항</div>
        <div class="tab hidden" data-tab="users" id="usersTab">가입자 목록</div>
      </div>
      <div class="userbox">
        <span id="roleBadge" class="role-badge">viewer</span>
        <button id="btnLogout" class="btn ghost">로그아웃</button>
      </div>
    </div>

    <div class="wrap">
      <!-- LEFT -->
      <aside class="side">
        <h4>카테고리</h4>
        <div id="catList" class="cat"></div>
      </aside>

      <!-- MAIN -->
      <main class="main">
<!-- Mobile Category Chips (모바일 전용) -->
<div id="catChipsWrap" class="cat-chips-wrap hidden">
  <div id="catChips" class="cat-chips"></div>
</div>
        <!-- MATERIALS -->
        <div id="view-materials">
          <div class="section-title">
            <h2 id="catTitle">타일</h2>
            <div class="toolbar">
              <button id="btnAddMaterial" class="btn hidden">추가</button>
              <span class="hint" id="materialsHint">관리자만 추가/수정 가능</span>
            </div>
          </div>
          <div id="materialsGrid" class="grid"></div>
          <div id="materialsEmpty" class="empty hidden">등록된 항목이 없습니다.</div>
        </div>

        <!-- PROGRESS: 사진 갤러리 -->
        <div id="view-progress" class="hidden">
          <div class="section-title">
            <h2>공사 진행사항</h2>
            <div class="toolbar">
              <button id="btnAddProgressPhoto" class="btn hidden">사진 업로드</button>
              <span class="hint">진행 현장을 사진으로 기록합니다.</span>
            </div>
          </div>
          <div id="progressGrid" class="grid"></div>
          <div id="progressEmpty" class="empty hidden">등록된 사진이 없습니다.</div>
        </div>

        <!-- USERS -->
        <div id="view-users" class="hidden">
  <div class="section-title"><h2>가입자 목록</h2></div>
  <div class="panel">
    <table id="adminUsersTable" class="admin-table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
    <th style="width:20%; text-align:left;">아이디</th>
    <th style="width:18%; text-align:left;">가입일</th>
    <th style="width:22%; text-align:left;">최종접속</th> 
    <th style="width:30%; text-align:left;">권한(현장)</th>
    <th style="width:10%; text-align:left;">비고</th>
        </tr>
      </thead>
      <tbody id="adminUsersBody"></tbody>
    </table>
    <div id="usersEmpty" class="empty hidden">가입자가 아직 없습니다.</div>
  </div>
</div>
      </main>

      <!-- RIGHT: 모든 역할 공통 - 기타 참고 사항 -->
      <aside class="right">
        <h3>기타 참고 사항</h3>
        <div id="rightPanel" class="panel">
          <textarea id="miscNote" placeholder="현장 유의사항, 고객 요청사항 등을 기록합니다."></textarea>
          <div class="row" style="margin-top:10px">
            <button id="btnSaveNote" class="btn secondary">메모 저장</button>
            <span id="noteSaved" class="helper"></span>
          </div>
          <div id="viewerHint" class="helper hidden">고객 계정은 읽기 전용입니다.</div>
        </div>
      </aside>
    </div>
  </section>

  <!-- =================== MODALS =================== -->
  <div id="modalAdmin" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <div class="hd">
        <div>관리자 로그인</div>
        <button class="btn ghost" data-close>닫기</button>
      </div>
      <div class="bd">
        <label>관리자 번호</label>
        <input id="adminCodeInput" type="password" inputmode="numeric" />
        <div class="row" style="margin-top:12px">
          <button id="btnAdminConfirm" class="btn">관리자 모드로 들어가기</button>
          <button class="btn secondary" data-close>취소</button>
        </div>
        <div id="adminMsg" class="helper"></div>
      </div>
    </div>
  </div>

  <div id="modalSignup" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <div class="hd">
        <div>회원가입</div>
        <button class="btn ghost" data-close>닫기</button>
      </div>
      <div class="bd">
        <label>아이디</label>
        <input id="suId" type="text" placeholder="your_id" />
        <label>비밀번호</label>
        <input id="suPw" type="password" placeholder="••••••••" />
        <label>비밀번호 확인</label>
        <input id="suPw2" type="password" placeholder="••••••••" />
        <label>관리자 번호 (초대코드)</label>
        <input id="suCode" type="password" inputmode="numeric" />
        <div class="row" style="margin-top:12px">
          <button id="btnSignup" class="btn">가입</button>
          <button class="btn secondary" data-close>취소</button>
        </div>
        <div id="signupMsg" class="helper"></div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Material -->
  <div id="modalMaterial" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <div class="hd">
        <div>항목 추가/수정</div>
        <button class="btn ghost" data-close>닫기</button>
      </div>
      <div class="bd">
        <label>제목</label>
        <input id="matTitle" type="text" placeholder="예) 거실 바닥 타일" />
        <label>이름</label>
        <input id="matName" type="text" placeholder="예) 포세린 600×600 밝은그레이" />
        <label>이미지</label>
        <input id="matFile" type="file" accept="image/*" />
        <div class="row" style="margin-top:12px">
          <button id="btnMaterialSave" class="btn">저장</button>
          <button class="btn secondary" data-close>취소</button>
        </div>
        <div id="materialMsg" class="helper"></div>
      </div>
    </div>
  </div>

  <!-- Progress Photo Upload -->
  <div id="modalProgress" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="dialog" role="dialog" aria-modal="true">
      <div class="hd">
        <div>진행 사진 업로드</div>
        <button class="btn ghost" data-close>닫기</button>
      </div>
      <div class="bd">
        <label>제목</label>
        <input id="proTitle" type="text" placeholder="예) 거실 타일 시공" />
        <label>이름(촬영자/현장명 등)</label>
        <input id="proName" type="text" placeholder="예) 김시공 / 1002동" />
        <label>사진</label>
        <input id="proFile" type="file" accept="image/*" />
        <div class="row" style="margin-top:12px">
          <button id="btnProgressSave" class="btn">업로드</button>
          <button class="btn secondary" data-close>취소</button>
        </div>
        <div id="progressMsg" class="helper"></div>
      </div>
    </div>
  </div>

<div id="modalSite" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true">
    <div class="hd">
      <div>현장 추가</div>
      <button class="btn ghost" data-close>닫기</button>
    </div>
    <div class="bd">
      <label>현장명</label>
      <input id="siteNameInput" type="text" placeholder="예) 101동 1203호" />
      <label style="margin-top:10px">현장 ID (영문/숫자/하이픈/언더바)</label>
      <input id="siteIdInput" type="text" placeholder="예) 101dong-1203" />
      <div class="helper">* ID는 중복되면 안 됩니다. 미입력시 이름을 기반으로 자동 생성됩니다.</div>
      <div class="row" style="margin-top:12px">
        <button id="btnSiteSave" class="btn">저장</button>
        <button class="btn secondary" data-close>취소</button>
      </div>
      <div id="siteMsg" class="helper"></div>
    </div>
  </div>
</div>

<!-- Site Picker (Admin only) -->
<div id="modalSitePick" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true" style="max-width:560px">
    <div class="hd">
      <div>어느 현장을 열까요?</div>
      <div class="row">
        <button id="btnSitePickAdd" class="btn">추가</button>
        <button class="btn ghost" data-close>닫기</button>
      </div>
    </div>
    <div class="bd">
      <div id="sitePickList"></div>
      <div class="helper" style="margin-top:10px">
        필요하면 상단의 ‘추가’ 버튼으로 새 현장을 만들 수 있어요.
      </div>
    </div>
  </div>
</div>

<!-- Image Viewer -->
<div id="modalImage" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true">
    <div class="hd">
      <div id="imgTitle">이미지 보기</div>
      <button class="btn ghost" data-close>닫기</button>
    </div>
    <div class="bd">
      <div class="img-wrap">
        <img id="imgViewer" alt="미리보기" />
      </div>
      <div id="imgCaption" class="img-caption"></div>
    </div>
  </div>
</div>

  <!-- =================== TOAST =================== -->
  <div id="toast" class="toast"></div>

<!-- =================== LOADING =================== -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-box">
    <div class="spinner lg"></div>
    <div class="loading-text">로딩중...</div>
  </div>
</div>

  <script>
    // =================== CONFIG ===================
const ADMIN_CODE = "176012";
const API_BASE = "https://script.google.com/macros/s/AKfycbyf4oHbNRo027lb1LmFa2VokWjf-142YRpJbfSl2jPiQ4Zw9ZyAQQPh6niuVHARIqo/exec";
const USE_STRICT_API = true;
const DEMO_MODE = !API_BASE || API_BASE.includes('REPLACE_WITH_YOUR_DEPLOYMENT_ID');

const isDataUrlImage = (u) => /^data:image\/(png|jpe?g|webp);base64,/.test(String(u||''));

    const CATEGORIES = ["타일","창호","필름","도배","바닥","씽크대","가구","기타"];

    const Session = { token:null, role:"viewer", userId:null };

    const DB = {
      lists: {},                 // {cat: [{title,name,imgUrl,updatedAt}]}
      progressPhotos: [],        // [{title,name,imgUrl,date}]
      users: []
    };

// ====== Global Loading Overlay ======
const $loadingOverlay = document.getElementById('loadingOverlay');
let loadingCount = 0;

function pushLoading() {
  loadingCount++;
  $loadingOverlay.style.display = 'flex';
}

function popLoading() {
  loadingCount = Math.max(0, loadingCount - 1);
  if (loadingCount === 0) $loadingOverlay.style.display = 'none';
}

// 헬퍼: 비동기 함수 실행 시 자동 로딩 표시
async function withLoading(promise, label = "로딩중...") {
  pushLoading();
  const text = $loadingOverlay.querySelector(".loading-text");
  if (text) text.textContent = label;
  try {
    const result = await promise;
    popLoading();
    return result;
  } catch (err) {
    popLoading();
    throw err;
  }
}

// ▼ 사이트 상태 (드롭박스 선택값 + 목록)
const SiteState = {
  currentId: 'default',   // 드롭박스 선택된 siteId
  list: []                // [{id:'default', name:'기본 현장'}, …] 채울 예정
};

// ▼ 노트 캐시 (siteId × category)
const NoteCache = Object.create(null);
function noteCacheGet(siteId, cat) {
  const bucket = NoteCache[siteId];
  return bucket ? (bucket[cat] || null) : null;
}
function noteCachePut(siteId, cat, text) {
  (NoteCache[siteId] ||= Object.create(null))[cat] = { text, ts: Date.now() };
}

    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const on = (el,ev,fn)=>el&&el.addEventListener(ev,fn);
    const today = () => new Date().toISOString().slice(0,10);

function isMobile(){
  return window.matchMedia('(max-width: 720px)').matches;
}

    function toast(msg, ms=1800){
      const box = $("#toast");
      box.textContent = msg; box.style.display = 'block';
      clearTimeout(box._t); box._t = setTimeout(()=> box.style.display='none', ms);
    }

function formatLastSeenKR(iso){
  if (!iso) return '—';
  const d = new Date(iso);
  if (isNaN(d)) return '—';
  const now = new Date();
  let diff = Math.max(0, now - d);

  const MIN = 60*1000, HOUR = 60*MIN, DAY = 24*HOUR, MONTH = 30*DAY, YEAR = 365*DAY;
  const years  = Math.floor(diff / YEAR);  diff %= YEAR;
  const months = Math.floor(diff / MONTH); diff %= MONTH;
  const days   = Math.floor(diff / DAY);   diff %= DAY;
  const hours  = Math.floor(diff / HOUR);  diff %= HOUR;
  const mins   = Math.floor(diff / MIN);

  const parts = [];
  if (years)  parts.push(`${years}년`);
  if (months) parts.push(`${months}월`);
  if (days)   parts.push(`${days}일`);
  if (hours)  parts.push(`${hours}시`);
  if (mins)   parts.push(`${mins}분`);
  return parts.length ? parts.join(' ') + ' 전' : '방금 전';
}

// 절대시간: "YYYY-MM-DD HH:MM" (KST)
function formatKSTDateTime(val){
  if (!val) return '';
  let d = (val instanceof Date) ? val : null;

  if (!d) {
    const s = String(val).trim();
    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(s)) return s;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s + ' 00:00';

    const try1 = new Date(s);
    if (!isNaN(try1.getTime())) d = try1;
    else {
      const m = /^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/.exec(s);
      if (m) d = new Date(`${m[1]}T${m[2]}:${m[3]}:00+09:00`);
    }
  }

  if (!d || isNaN(d.getTime())) return String(val);

  const parts = new Intl.DateTimeFormat('ko-KR', {
    timeZone: 'Asia/Seoul',
    hour12: false,
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit'
  }).formatToParts(d).reduce((a,p)=> (a[p.type]=p.value, a), {});

  return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}`;
}

// 날짜만: "YYYY-MM-DD" (KST)
function formatKSTDate(val){
  if (!val) return '';
  let d = (val instanceof Date) ? val : null;

  if (!d) {
    const s = String(val).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m2 = /^(\d{4}-\d{2}-\d{2})[ T]\d{2}:\d{2}/.exec(s);
    if (m2) return m2[1];

    const try1 = new Date(s);
    if (!isNaN(try1.getTime())) d = try1;
    else {
      const m = /^(\d{4}-\d{2}-\d{2})[ T](\d{2}):(\d{2})/.exec(s);
      if (m) d = new Date(`${m[1]}T${m[2]}:${m[3]}:00+09:00`);
    }
  }

  if (!d || isNaN(d.getTime())) return String(val);

  const parts = new Intl.DateTimeFormat('ko-KR', {
    timeZone: 'Asia/Seoul',
    year:'numeric', month:'2-digit', day:'2-digit'
  }).formatToParts(d).reduce((a,p)=> (a[p.type]=p.value, a), {});

  return `${parts.year}-${parts.month}-${parts.day}`;
}

// ====== SITES: load & select helpers ======
async function loadSites(opts = {}) {
  const autopick = opts.autopick !== false; // 기본 true
  let items = [];
  try {
    const res = await api('list_sites', {});
    if (res?.ok && Array.isArray(res.sites)) items = res.sites;
  } catch (_) {}

  if (!items.length) items = [{ id: 'default', name: '기본 현장' }];

  SiteState.list = items;

  if (autopick) {
    if (!SiteState.currentId || !items.some(s => s.id === SiteState.currentId)) {
      SiteState.currentId = items[0].id;
    }
  } else {
    // 관리자 첫 진입용: 자동 선택 안 함
    if (!items.some(s => s.id === SiteState.currentId)) {
      SiteState.currentId = ''; // 선택 보류
    }
  }
  populateSiteSelect();
}

function populateSiteSelect() {
  if (!$siteSelect) return;
   $siteSelect.innerHTML = '';
 if (!SiteState.currentId) {
   const opt0 = document.createElement('option');
   opt0.value = '';
   opt0.textContent = '현장 선택';
   opt0.disabled = true; opt0.selected = true;
   $siteSelect.appendChild(opt0);
 }
  SiteState.list.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.name || s.id;
    $siteSelect.appendChild(opt);
  });
  // 선택값만 반영 (onchange 바인딩은 enterApp()에서 _bound 체크로 1회만)
  $siteSelect.value = SiteState.currentId;
}

function ensureSiteSelected(){
  if (!SiteState.currentId && SiteState.list.length){
    SiteState.currentId = SiteState.list[0].id;
  }
}

 async function loadAllForSite(siteId){
   if (siteId && siteId !== SiteState.currentId) {
     SiteState.currentId = siteId;
   }
   await withLoading(loadAll(), "현장 데이터 불러오는 중...");
 }

async function setSiteAndReload(siteId){
  if (!siteId) return;

  // 0) 상태 업데이트
  const changed = (siteId !== SiteState.currentId);
  SiteState.currentId = siteId;

  // 1) 상단 드롭박스 값도 즉시 반영 (옵션이 없으면 안전하게 추가)
  if ($siteSelect) {
    if (![...$siteSelect.options].some(o => o.value === siteId)) {
      const opt = document.createElement('option');
      opt.value = siteId;
      opt.textContent = (SiteState.list.find(s => s.id === siteId)?.name || siteId);
      $siteSelect.appendChild(opt);
    }
    $siteSelect.value = siteId;
  }

  // 2) 선택된 현장 데이터 재로드
  await loadAllForSite(siteId);

  // 3) 화면 다시 그리기
  const cat = ($catTitle?.textContent || '타일').trim();
  renderMaterials(cat);
  renderProgress();
  renderUsers();
}

function slugifyId(name){
  const s = String(name||'').toLowerCase().trim()
    .replace(/[^\w\-]+/g,'-')      // 영문/숫자/밑줄/하이픈만
    .replace(/^-+|-+$/g,'')        // 앞뒤 하이픈 제거
    .slice(0, 40);                 // 너무 길면 컷
  return s || ('site-' + Date.now().toString(36));
}

function openSiteModal(){
  $siteMsg.textContent = '';
  $siteNameInput.value = '';
  $siteIdInput.value = '';
  let touchedId = false;

  // 이름 입력 시 ID 자동 생성 (ID 입력칸을 사용자가 수정하기 전까지만)
  $siteNameInput.oninput = () => {
    if (!touchedId) $siteIdInput.value = slugifyId($siteNameInput.value);
  };
  $siteIdInput.oninput = () => touchedId = true;

  $modalSite.style.display = 'block';
  $siteNameInput.focus();
}

async function saveNewSite(){
  $siteMsg.textContent = '';
  const name = $siteNameInput.value.trim();
  let id = $siteIdInput.value.trim();

  if (!name){ $siteMsg.textContent = '현장명을 입력하세요.'; return; }
  if (!id) id = slugifyId(name);
  if (!/^[A-Za-z0-9_-]+$/.test(id)){ $siteMsg.textContent = 'ID는 영문/숫자/하이픈/언더바만 가능합니다.'; return; }

  // 관리자만 허용
  if (Session.role !== 'admin'){ $siteMsg.textContent = '관리자만 추가할 수 있습니다.'; return; }

  // 백엔드: upsert_site → 없으면 add_site로 폴백
  let res = await api('upsert_site', { id, name }).catch(()=>null);
  if (!res?.ok){
    res = await api('add_site', { id, name }).catch(()=>null);
  }
  if (!res?.ok){ $siteMsg.textContent = res?.msg || '서버 오류'; return; }

  // 목록 갱신 → 방금 만든 현장으로 전환
  await loadSites();
  populateSiteSelect();
  setSiteAndReload(id);

  // 모달 닫기
  $modalSite.style.display = 'none';
  toast('현장 추가 완료');
}

// === Site Picker ===
function renderSitePickList(){
  if (!$sitePickList) return;
  const arr = SiteState.list || [];
  $sitePickList.innerHTML = arr.map(s => `
    <button class="btn secondary" data-site="${escapeAttr(s.id)}"
            style="width:100%; text-align:left; margin:6px 0">
      ${escapeHtml(s.name || s.id)}
    </button>
  `).join('');

  // 클릭해서 해당 현장 로딩
  $sitePickList.querySelectorAll('[data-site]').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const id = e.currentTarget.getAttribute('data-site');
      closeModal($modalSitePick);
      await setSiteAndReload(id);
    });
  });
}

function openSitePicker(){
  if (!$modalSitePick) return;
  renderSitePickList();

  window.scrollTo(0, 0);          // ★ 추가: 모바일에서 상단으로 올려 가림 방지

  $modalSitePick.style.display = 'block';
}

    // =================== LOCAL DEMO STORE ===================
const Local = (()=>{

  // siteId별로 다른 키에 저장되도록 함수형 키 사용
const KEY = {
  users: 'mapp.users',
  lists:  (id)=> `mapp.${id}.lists.v3`,
  photos: (id)=> `mapp.${id}.progress.photos.v3`,
  note:   (id,cat)=> `mapp.${id}.note.${cat}.v1`,   // ★ 변경
};

  const load=(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch(_){ return d; } };
  const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v));

  const baseLists = ()=>{ const b={}; CATEGORIES.forEach(c=> b[c]=[]); return b; };

  // siteId별 초기화
  function initSite(id){
    if(!load(KEY.lists(id),  null)) save(KEY.lists(id),  baseLists());
    if(!load(KEY.photos(id), null)) save(KEY.photos(id), []);
  }

  function handle(type, payload){
    const siteId = String((payload && payload.siteId) || SiteState.currentId || 'default');
    initSite(siteId);

    const ok  = (extra={})=> ({ ok:true,  ...extra });
    const bad = (msg)=>      ({ ok:false, msg });

    switch(type){
      case 'ping': return ok({mode:'local'});

      // ---- Auth (현행 유지) ----
      case 'signup':{
        const users = load(KEY.users, []);
        const {id,pw,code}=payload||{};
        if(!id||!pw||!code) return bad('모든 항목을 입력하세요.');
        if(code!==ADMIN_CODE) return bad('관리자 번호가 올바르지 않습니다.');
        if(users.find(u=>u.id===id)) return bad('이미 존재하는 아이디입니다.');
        users.push({id,pw,created:new Date().toISOString(),note:''});
        save(KEY.users, users);
        return ok();
      }
      case 'login':{
  const users = load(KEY.users, []);
  const {id,pw}=payload||{};
  const u=users.find(u=>u.id===id&&u.pw===pw);
  if(!u) return bad('아이디 또는 비밀번호가 올바르지 않습니다.');
  u.lastLogin = new Date().toISOString();     // ★ 추가
  save(KEY.users, users);                      // ★ 저장
  return ok({token:'local-'+Math.random().toString(36).slice(2)});
}
case 'admin_login':{
  if((payload||{}).code!==ADMIN_CODE) return bad('관리자 번호가 올바르지 않습니다.');
  const users = load(KEY.users, []);
  // 관리자 가상계정(lastLogin 기록용) – 실제 운영에선 서버에서 처리
  const id = 'admin';
  let u = users.find(x => x.id === id);
  if (!u) { u = { id, pw:'', created:new Date().toISOString() }; users.push(u); }
  u.lastLogin = new Date().toISOString();     // ★ 추가
  save(KEY.users, users);                      // ★ 저장
  return ok({token:'admin-'+Math.random().toString(36).slice(2)});
}

      // ---- Read All (siteId별로 분리) ----
     case 'get_all':{
  const lists  = load(KEY.lists(siteId),  baseLists());
  const photos = load(KEY.photos(siteId), []);
  const users  = load(KEY.users, []);
  const materials=[];
  Object.keys(lists).forEach(cat=>{
    (lists[cat]||[]).forEach(r=>{
      materials.push({
        category:cat,
        title:r.title||'',
        name:r.name||'',
        imgUrl:r.imgUrl||'',
        updatedAt:r.updatedAt||''
      });
    });
  });
  // ★ users 그대로 반환하면 lastLogin 포함
  return ok({ materials, progressPhotos:photos, users });
}

      // ---- Materials (siteId별로 분리) ----
      case 'save_material':{
        const {category,title='',name='',imgUrl='',updatedAt=''}=payload||{};
        if(!category) return bad('카테고리 누락');
        const lists = load(KEY.lists(siteId), baseLists());
        const arr=(lists[category] ||= []);
        const idx=arr.findIndex(x=> x.title===title && x.name===name);
        const rec={title,name,imgUrl,updatedAt:(updatedAt||today())};
        if(idx>=0) arr[idx]=rec; else arr.push(rec);
        save(KEY.lists(siteId), lists);
        return ok();
      }
      case 'delete_material':{
        const {category,title='',name=''}=payload||{};
        const lists = load(KEY.lists(siteId), baseLists());
        const arr=lists[category]||[];
        lists[category]=arr.filter(x=> !(x.title===title && x.name===name));
        save(KEY.lists(siteId), lists);
        return ok();
      }

      // ---- Image Echo (base64) ----
      case 'upload_image':{
        const {dataUrl}=payload||{};
        if(!dataUrl) return bad('이미지를 선택하세요.');
        return ok({url:dataUrl}); // 그대로 에코백
      }

      // ---- Progress Photos (siteId별로 분리) ----
      case 'progress_upload':{
        const {title='',name='',imgUrl=''}=payload||{};
        const photos = load(KEY.photos(siteId), []);
        const rec={title,name,imgUrl,date:today()};
        photos.push(rec);
        save(KEY.photos(siteId), photos);
        return ok(rec);
      }

      // ---- Note (siteId별로 분리) ----
case 'save_note':{
  const { text='', category='타일' } = payload || {};
  save(KEY.note(siteId, category), text);
  return ok();
}
case 'load_note':{
  const { category='타일' } = payload || {};
  return ok({ text: load(KEY.note(siteId, category), '') });
}

      default:
        return bad('로컬 모드에서 지원되지 않는 요청: '+type);
    }
  }

  return {handle};
})();

async function api(type, payload = {}) {
  // 로딩 시작
  pushLoading();
  const text = $loadingOverlay?.querySelector(".loading-text");
  if (text) text.textContent = "로딩중...";

  try {
    if (DEMO_MODE) {
      // 로컬 핸들러도 로딩 UI를 동일하게 경험하도록
      const result = await Promise.resolve(Local.handle(type, payload));
      return result;
    }

    const url = API_BASE + "?type=" + encodeURIComponent(type);
    const headers = { 'Content-Type': 'text/plain' };
    const body = JSON.stringify({ ...payload, token: Session.token });

    const res = await fetch(url, { method: 'POST', headers, body });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    return data;
  } catch (err) {
    console.warn('[api] error', type, err);
    if (USE_STRICT_API) throw err;
    return null;
  } finally {
    // 로딩 종료 (성공/실패 모두)
    popLoading();
  }
}

// ====== Silent API (no spinner) ======
async function apiSilent(type, payload = {}) {
  try {
    if (DEMO_MODE) {
      return Promise.resolve(Local.handle(type, payload));
    }
    const url = API_BASE + "?type=" + encodeURIComponent(type);
    const headers = { 'Content-Type': 'text/plain' };
    const body = JSON.stringify({ ...payload, token: Session.token });
    const res = await fetch(url, { method: 'POST', headers, body });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  } catch (err) {
    console.warn('[apiSilent] error', type, err);
    if (USE_STRICT_API) throw err;
    return null;
  }
}

    // ========= AUTH =========
    const $auth=$("#auth"), $app=$("#app");
    const $loginId=$("#loginId"), $loginPw=$("#loginPw");
    const $btnLogin=$("#btnLogin"), $btnAdminLogin=$("#btnAdminLogin"), $btnOpenSignup=$("#btnOpenSignup");
    const $authMsg=$("#authMsg");
    const $modalAdmin=$("#modalAdmin"), $modalSignup=$("#modalSignup");
    const $adminCodeInput=$("#adminCodeInput"), $btnAdminConfirm=$("#btnAdminConfirm"), $adminMsg=$("#adminMsg");
    const $suId=$("#suId"), $suPw=$("#suPw"), $suPw2=$("#suPw2"), $suCode=$("#suCode"), $btnSignup=$("#btnSignup"), $signupMsg=$("#signupMsg");

const $authTitle = document.querySelector('#auth .title');

    function openModal(m){ m.style.display='block'; }
    function closeModal(m){ m.style.display='none'; }
    $$('[data-close]').forEach(b=> on(b,'click',()=> closeModal(b.closest('.modal'))));
    [ $modalAdmin, $modalSignup ].forEach(m=> on(m.querySelector('.backdrop'),'click',()=> closeModal(m)));

// ===== 관리자 비밀 진입: 제목 3번 탭 =====
let adminTapCount = 0;
let adminTapTimer = null;

function triggerAdminLoginModal(){
  if (!$modalAdmin) return;
  $adminCodeInput.value = '';
  $adminMsg.textContent = '';
  openModal($modalAdmin);
  $adminCodeInput.focus();
}

function bindAdminSecretTap(el){
  if (!el) return;

  const handleTap = () => {
    adminTapCount++;
    // 첫 탭 시 타이머 시작 (1.2초 안에 3번)
    if (adminTapCount === 1){
      adminTapTimer = setTimeout(() => {
        adminTapCount = 0;
        adminTapTimer = null;
      }, 1200);
    }
    // 3번째 탭이면 관리자 모달 오픈
    if (adminTapCount >= 3){
      if (adminTapTimer) {
        clearTimeout(adminTapTimer);
        adminTapTimer = null;
      }
      adminTapCount = 0;
      triggerAdminLoginModal();
    }
  };

  // 마우스 클릭
  el.addEventListener('click', handleTap);

  // 터치 (모바일 탭)
  el.addEventListener('touchstart', () => {
    handleTap();
  }, { passive: true });
}

// 로그인 화면의 "공사진행 관리" 텍스트에 비밀 탭 바인딩
bindAdminSecretTap($authTitle);

    on($btnLogin,'click', async ()=>{
      $authMsg.textContent='';
      const id=$loginId.value.trim(), pw=$loginPw.value.trim();
      if(!id||!pw){ $authMsg.textContent='아이디/비밀번호를 입력하세요.'; return; }
      const res=await api('login',{id,pw}).catch(()=>null);
      if(!res||!res.ok){ $authMsg.textContent=res?.msg||'로그인 실패'; return; }
      Session.token=res.token||null; Session.role='viewer'; Session.userId=id;
      enterApp();
    });

    on($btnAdminConfirm,'click', async ()=>{
      const code=$adminCodeInput.value.trim();
      if(!code){ $adminMsg.textContent='관리자 번호를 입력하세요.'; return; }
      if(code!==ADMIN_CODE){ $adminMsg.textContent='관리자 번호가 올바르지 않습니다.'; return; }
      const res=await api('admin_login',{code}).catch(()=>null);
      if(!res||!res.ok){ $adminMsg.textContent=res?.msg||'서버 인증 실패'; return; }
      Session.token=res.token||Session.token; Session.role='admin';
      closeModal($modalAdmin); enterApp(); toast('관리자 모드 활성화');
    });

    on($btnOpenSignup,'click', ()=>{ $signupMsg.textContent=''; $suId.value=''; $suPw.value=''; $suPw2.value=''; $suCode.value=''; openModal($modalSignup); });
    on($btnSignup,'click', async ()=>{
      $signupMsg.textContent='';
      const id=$suId.value.trim(), pw=$suPw.value.trim(), pw2=$suPw2.value.trim(), code=$suCode.value.trim();
      if(!id||!pw||!pw2||!code){ $signupMsg.textContent='모든 항목을 입력하세요.'; return; }
      if(pw!==pw2){ $signupMsg.textContent='비밀번호가 일치하지 않습니다.'; return; }
      if(code!==ADMIN_CODE){ $signupMsg.textContent='관리자 번호(초대코드)가 올바르지 않습니다.'; return; }
      const res=await api('signup',{id,pw,code}).catch(()=>null);
      if(!res||!res.ok){ $signupMsg.textContent=res?.msg||'가입 실패'; return; }
      closeModal($modalSignup); toast('가입 완료! 이제 로그인하세요.');
    });

    on($('#btnLogout'),'click', ()=> location.reload());

    // ========= APP UI =========
    const $roleBadge=$('#roleBadge'), $usersTab=$('#usersTab'), $envRibbon=$('#envRibbon');
    const $catList=$('#catList'), $catTitle=$('#catTitle'), $materialsGrid=$('#materialsGrid'), $materialsEmpty=$('#materialsEmpty'), $btnAddMaterial=$('#btnAddMaterial'), $materialsHint=$('#materialsHint');
// ▼ 현장 드롭박스 / 관리 버튼
const $siteSelect = $('#siteSelect');        // <select id="siteSelect">
const $btnManageSites = $('#btnSiteManage'); // <button id="btnManageSites">
    const $viewMaterials=$('#view-materials'), $viewProgress=$('#view-progress'), $viewUsers=$('#view-users');
    const $usersTbody=$('#usersTbody'), $usersEmpty=$('#usersEmpty');

    const $miscNote=$('#miscNote'), $btnSaveNote=$('#btnSaveNote'), $noteSaved=$('#noteSaved'), $viewerHint=$('#viewerHint');

    const $progressGrid=$('#progressGrid'), $progressEmpty=$('#progressEmpty'), $btnAddProgressPhoto=$('#btnAddProgressPhoto');

    const $modalMaterial=$('#modalMaterial'), $matTitle=$('#matTitle'), $matName=$('#matName'), $matFile=$('#matFile'), $btnMaterialSave=$('#btnMaterialSave'), $materialMsg=$('#materialMsg');
    const $modalProgress=$('#modalProgress'), $proTitle=$('#proTitle'), $proName=$('#proName'), $proFile=$('#proFile'), $btnProgressSave=$('#btnProgressSave'), $progressMsg=$('#progressMsg');

// 이미지 뷰어 모달
const $modalImage  = $('#modalImage');
const $imgViewer   = $('#imgViewer');
const $imgTitle    = $('#imgTitle');
const $imgCaption  = $('#imgCaption');

const $btnSiteAdd    = $('#btnSiteAdd');     // 상단 + 버튼
const $modalSite     = $('#modalSite');
const $siteNameInput = $('#siteNameInput');
const $siteIdInput   = $('#siteIdInput');
const $btnSiteSave   = $('#btnSiteSave');    // ★ HTML의 버튼 id와 반드시 일치시켜 주세요
const $siteMsg       = $('#siteMsg');

const $modalSitePick = $('#modalSitePick');
const $sitePickList  = $('#sitePickList');
const $sitePickClose = $$('#modalSitePick [data-close]')[0] || null;

// SitePick 헤더의 '추가' 버튼 → 현장 추가 모달 열기
const $btnSitePickAdd = $('#btnSitePickAdd');
if ($btnSitePickAdd && !$btnSitePickAdd._bound){
  on($btnSitePickAdd, 'click', () => {
    closeModal($modalSitePick);  // 픽커 닫고
    openSiteModal();             // 기존 현장 추가 모달 열기 (상단 + 버튼과 동일 기능)
  });
  $btnSitePickAdd._bound = true;
}

// 상단 현장 +추가 / 현장관리(픽커) 버튼
if ($btnSiteAdd && !$btnSiteAdd._bound){
  on($btnSiteAdd, 'click', openSiteModal);
  $btnSiteAdd._bound = true;
}
if ($btnManageSites && !$btnManageSites._bound){
  on($btnManageSites, 'click', openSitePicker);
  $btnManageSites._bound = true;
}

// ⬇ 저장 버튼 & 엔터키 바인딩 추가
if ($btnSiteSave && !$btnSiteSave._bound){
  on($btnSiteSave, 'click', async ()=>{
    try {
      await saveNewSite();
    } catch (e){
      console.warn(e);
      $siteMsg.textContent = '저장 실패';
    }
  });
  $btnSiteSave._bound = true;
}

[$siteNameInput, $siteIdInput].forEach(inp=>{
  on(inp, 'keydown', (e)=>{
    if (e.key === 'Enter'){ e.preventDefault(); $btnSiteSave.click(); }
  });
});

on($('.backdrop', $modalSite),'click', ()=> closeModal($modalSite));
$$('#modalSite [data-close]').forEach(b => on(b,'click',()=> closeModal($modalSite)));

on($('.backdrop', $modalImage), 'click', ()=> closeModal($modalImage));
$$('#modalImage [data-close]').forEach(b => on(b,'click',()=> closeModal($modalImage)));

on($('.backdrop', $modalSitePick), 'click', ()=> closeModal($modalSitePick));
$$('#modalSitePick [data-close]').forEach(b => on(b,'click',()=> closeModal($modalSitePick)));

// 큰 이미지 클릭하면 닫기 (zoom-out 커서 동작과 일치)
on($imgViewer, 'click', () => closeModal($modalImage));

// Esc 키로도 닫기
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && $modalImage.style.display === 'block') {
    closeModal($modalImage);
  }
});

function openImageViewer(src, title = '', subtitle = '') {
  if (!isDataUrlImage(src)) {
    toast('이미지를 불러올 수 없습니다.');
    return;
  }
  $imgViewer.src = src;
  $imgViewer.alt = (title || '미리보기');
  $imgTitle.textContent = title || '이미지 보기';
  $imgCaption.textContent = subtitle ? String(subtitle) : '';
  $modalImage.style.display = 'block';
}

$$('.tab').forEach(t => on(t, 'click', () => {
  $$('.tab').forEach(x => x.classList.remove('active'));
  t.classList.add('active');

  const key = t.dataset.tab;
  [$viewMaterials, $viewProgress, $viewUsers].forEach(v => v.classList.add('hidden'));
  if (key === 'materials') $viewMaterials.classList.remove('hidden');
  if (key === 'progress')  $viewProgress.classList.remove('hidden');
  if (key === 'users') {
    $viewUsers.classList.remove('hidden');
    if (Session.role === 'admin') adminLoadUsersAndPerms(); // ★ 유지
  }

  // ★ 노트 갱신 (진행사항 탭이면 '__progress__' 키 사용)
  loadNoteForCurrentCategory();
}));

    function renderCategories(active="타일"){
  $catList.innerHTML='';
  CATEGORIES.forEach(cat=>{
    const b=document.createElement('button');
    b.textContent=cat; 
    b.className=cat===active?'active':'';

    on(b,'click', ()=>{
      // 항상 카테고리 렌더
      renderMaterials(cat);

      // ★ 진행사항 탭에서 클릭한 경우 → '선택한 마감재' 탭으로 전환
      const activeTab = document.querySelector('.tab.active')?.dataset.tab;
      if (activeTab === 'progress') {
        // 탭 상태 전환
        $$('.tab').forEach(x=>x.classList.remove('active'));
        const matTab = document.querySelector('.tab[data-tab="materials"]');
        if (matTab) matTab.classList.add('active');

        // 뷰 전환
        [$viewMaterials,$viewProgress,$viewUsers].forEach(v=>v.classList.add('hidden'));
        $viewMaterials.classList.remove('hidden');

        // 노트도 카테고리 기준으로 갱신
        loadNoteForCurrentCategory();
      }
    });

    $catList.appendChild(b);
  });
}

function renderCategoriesMobile(active = "타일"){
  const wrap = document.getElementById('catChips');
  const bar  = document.getElementById('catChipsWrap');
  if (!wrap || !bar) return;

  // 모바일이 아니면 칩 바 감춤
  if (!isMobile()){
    bar.classList.add('hidden');
    wrap.innerHTML = '';
    return;
  }

  // 모바일이면 칩 바 표시
  bar.classList.remove('hidden');

  // 칩들 렌더
  wrap.innerHTML = '';
  CATEGORIES.forEach(cat=>{
    const b = document.createElement('button');
    b.className = 'cat-chip' + (cat===active ? ' active' : '');
    b.textContent = cat;
    b.addEventListener('click', ()=>{
  renderMaterials(cat);          // 기존 동작

  // ★ 진행사항 탭이면 materials 탭으로 전환
  const activeTab = document.querySelector('.tab.active')?.dataset.tab;
  if (activeTab === 'progress') {
    $$('.tab').forEach(x=>x.classList.remove('active'));
    const matTab = document.querySelector('.tab[data-tab="materials"]');
    if (matTab) matTab.classList.add('active');

    [$viewMaterials,$viewProgress,$viewUsers].forEach(v=>v.classList.add('hidden'));
    $viewMaterials.classList.remove('hidden');

    loadNoteForCurrentCategory();
  }

  renderCategoriesMobile(cat);   // 칩 active 동기화 (기존)
});
    wrap.appendChild(b);
  });
}

// 기존 렌더 함수
function renderMaterials(cat = "타일"){
window.currentCategory = cat;
  $catTitle.textContent = cat;
  renderCategories(cat);
  $materialsGrid.innerHTML = '';
  const isAdmin = (Session.role === 'admin');
  $btnAddMaterial.classList.toggle('hidden', !isAdmin);
  $materialsHint.textContent = isAdmin ? '이미지/제목/이름을 추가하세요.' : '관리자만 추가/수정 가능';

  const list = DB.lists[cat] || [];
  if (list.length === 0) {
    $materialsEmpty.classList.remove('hidden');
  } else {
    $materialsEmpty.classList.add('hidden');
    list.forEach(row => $materialsGrid.appendChild(renderItemCard(cat, row)));
  }

  // ★ 카테고리별 메모 갱신
  loadNoteForCurrentCategory();

  // ★ 모바일 칩 동기화
  renderCategoriesMobile(cat);
}

    function renderItemCard(category, row){
  const isAdmin = Session.role === 'admin';
  const wrap = document.createElement('div');
  wrap.className = 'item-card';

  const updated = row.updatedAt
  ? `<div class="mini">${formatKSTDateTime(row.updatedAt)}에 업로드됨</div>`
  : '';
  const safeSrc = (/^data:image\/(png|jpe?g|webp);base64,/).test(String(row.imgUrl||'')) ? row.imgUrl : '';

wrap.innerHTML = `
  <div class="item-thumb ${safeSrc ? 'zoomable' : ''}">
    ${ safeSrc ? `<img alt="${escapeAttr(row.title||'')}" src="${safeSrc}"/>`
               : `<div class="placeholder">이미지 없음</div>` }
    </div>
    <div class="item-body">
      <div class="item-title">${escapeHtml(row.title||'—')}</div>
<div class="item-name">${escapeHtml(row.name||'—')}</div>
      ${updated}
      <div class="admin-controls ${isAdmin ? 'visible' : ''}">
        <input class="titleInput" type="text" placeholder="제목" value="${escapeAttr(row.title || '')}" />
        <input class="nameInput"  type="text" placeholder="이름" value="${escapeAttr(row.name  || '')}" />
        <button class="btn" data-act="update">수정</button>
        <button class="btn secondary" data-act="delete">삭제</button>
      </div>
    </div>
  `;

  // [추가] 썸네일 클릭 시 큰 이미지 보기
  const $thumb = $('.item-thumb', wrap);
  if (safeSrc) {
    on($thumb, 'click', () => openImageViewer(safeSrc, row.title || '', row.name || ''));
  }

  if (isAdmin){
    const $update = $('[data-act=update]', wrap);
    const $del    = $('[data-act=delete]', wrap);
    const $title  = $('.titleInput', wrap);
    const $name   = $('.nameInput',  wrap);

    on($update, 'click', async ()=>{
      const newTitle = $title.value.trim();
      const newName  = $name.value.trim();
      if (!newTitle || !newName){ toast('제목/이름을 입력하세요.'); return; }

// 이미지 그대로 유지, 기존 키로 찾아 업데이트
const siteId = (SiteState && SiteState.currentId) ? SiteState.currentId : 'default';

const payload = {
  siteId,                  // ★ 현장 식별자 전달
  category,
  title: newTitle,
  name:  newName,
  imgUrl: row.imgUrl,      // 기존 이미지 유지
  // 서버가 updatedAt 생성하므로 없음

  // 기존 키(제목/이름)로 행 찾기
  origSiteId: siteId,      // ★ 기존 레코드도 같은 siteId로 찾음
  origTitle: row.title || '',
  origName:  row.name  || ''
};

      const res = await api('save_material', payload).catch(()=>null);
      if (res?.ok){
        toast('수정됨');
        await loadAll();
        renderMaterials(category);
      } else {
        toast(res?.msg || '수정 실패');
      }
    });

    on($del, 'click', async ()=>{
      if (!confirm('삭제하시겠습니까?')) return;
      const res = await api('delete_material', {
   siteId:  SiteState.currentId,
   category,
   title: row.title || '',
   name:  row.name  || ''
}).catch(()=>null);
      if (res?.ok){
        toast('삭제됨');
        await loadAll();
        renderMaterials(category);
      } else {
        toast('삭제 실패');
      }
    });
  }
  return wrap;
}

// Base64(data URL)를 셀 한도(5만자) 이하로 강제해서 업로드
async function uploadImage(file){
  const LIMIT = 48000; // 안전 마진 포함
  const dataUrl = await toBase64UnderLimit(file, LIMIT);

  console.log('[uploadImage] len=', dataUrl.length, 'mime=', dataUrl.slice(5, dataUrl.indexOf(';')));

  // 서버는 그대로 에코백만 하고, save_material 때 시트에 dataURL이 저장됨
  const res = await api('upload_image', { dataUrl }).catch(()=>null);
  if (res?.ok && res.url) return res.url;        // ← res.url == dataUrl
  throw new Error(res?.msg || 'upload failed');
}

/* [추가] 원본을 그대로 base64 dataURL로 변환 */
function fileToDataURL(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(String(r.result));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// 이미지 파일 → <img> 로 로드
function readImageFromFile(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

// 리사이즈 + JPEG 압축 → dataURL 반환
async function toCompressedDataURL(file, { maxDim = 1600, quality = 0.82 } = {}){
  const img = await readImageFromFile(file);
  const w = img.naturalWidth, h = img.naturalHeight;
  const scale = Math.min(1, maxDim / Math.max(w, h)); // 큰 변 기준 축소
  const tw = Math.max(1, Math.round(w * scale));
  const th = Math.max(1, Math.round(h * scale));

  const canvas = document.createElement('canvas');
  canvas.width = tw; canvas.height = th;
  const ctx = canvas.getContext('2d', { alpha:false });
  ctx.drawImage(img, 0, 0, tw, th);

  return canvas.toDataURL('image/jpeg', quality);
}

// 목표 글자수 이하가 될 때까지 품질/크기를 낮춰 dataURL 생성
async function toBase64UnderLimit(file, limit=48000){
  // 초기값(대부분의 현장 사진이 이 근방에서 45k 안으로 들어옴)
  let maxDim = 1280;
  let quality = 0.84;

  for (let i=0; i<8; i++){
    const dataUrl = await toCompressedDataURL(file, { maxDim, quality });
    if (dataUrl.length <= limit) return dataUrl;

    // 먼저 품질을 내리고, 충분히 낮아졌으면 크기를 줄인다
    if (quality > 0.58) quality -= 0.08;
    else maxDim = Math.round(maxDim * 0.8);
  }

  // 그래도 안되면 원본 base64로 시도(희박하게 5만자 이하일 수도 있음)
  const raw = await fileToDataURL(file);
  if (raw.length <= limit) return raw;

  throw new Error('이미지가 큽니다. 다른 기기에서도 보기 위해 50,000자 이하로 줄여야 합니다.');
}

    function renderProgress(){
  const isAdmin = (Session.role === 'admin');
  $btnAddProgressPhoto.classList.toggle('hidden', !isAdmin);

  $progressGrid.innerHTML = '';
  const rows = DB.progressPhotos || [];
  $progressEmpty.classList.toggle('hidden', rows.length > 0);

  rows.forEach(r=>{
    const card = document.createElement('div');
    card.className = 'item-card';

    const src = isDataUrlImage(r.imgUrl) ? r.imgUrl : '';
    const dateLine = r.date
  ? `<div class="mini">${formatKSTDateTime(r.date)}에 업로드됨</div>`
  : '';

    card.innerHTML = `
  <div class="item-thumb ${src ? 'zoomable' : ''}">
    ${ src
        ? `<img alt="${escapeAttr(r.title||'')}" src="${src}"/>`
        : `<div class="placeholder">이미지 없음</div>` }
  </div>
      <div class="item-body">
        <div class="item-title">${escapeHtml(r.title||'-')}</div>
<div class="item-name">${escapeHtml(r.name||'-')}</div>
        ${dateLine}
      </div>
    `;
    // 썸네일 클릭 시 큰 이미지
    const $thumb = $('.item-thumb', card);
    if (isDataUrlImage(r.imgUrl)) {
      on($thumb, 'click', ()=> openImageViewer(r.imgUrl, r.title || '', r.name || ''));
    }
    $progressGrid.appendChild(card);
  });
}

function renderUsers(){
  if (Session.role !== 'admin') return;
  adminLoadUsersAndPerms();
}

    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/'/g,'&#39;'); }

    async function loadAll(){
      const res=await api('get_all',{ siteId: SiteState.currentId }).catch(()=>null);
      if(!res||!res.ok) return;

      DB.lists={}; CATEGORIES.forEach(c=> DB.lists[c]=[]);
      (res.materials||[]).forEach(m=>{
  DB.lists[m.category] ||= [];
  DB.lists[m.category].push({
    title:     m.title || '',
    name:      m.name  || '',
    imgUrl:    isDataUrlImage(m.imgUrl) ? m.imgUrl : '',
    updatedAt: m.updatedAt || ''
  });
});

      DB.progressPhotos = Array.isArray(res.progressPhotos) ? res.progressPhotos : [];
      DB.users = Array.isArray(res.users) ? res.users : [];
    }

    async function enterApp(){
  // 기본 UI 전환
  $auth.style.display = 'none';
  $app.style.display  = 'grid';
  $roleBadge.textContent = Session.role;
  $usersTab.classList.toggle('hidden', Session.role !== 'admin');

// === [SITE BOOT] 현장 초기화 ===
await loadSites({ autopick: Session.role !== 'admin' }); // 관리자면 자동 선택 X
populateSiteSelect();

if ($siteSelect && !$siteSelect._bound) {
  $siteSelect.addEventListener('change', (e) => {
    setSiteAndReload(e.target.value);
  });
  $siteSelect._bound = true;
}

if (Session.role === 'admin') {
  // ★ 관리자: 먼저 현장만 고르게 하고, 이때까지는 데이터 로딩 안 함
  renderCategories('타일');      // 왼쪽 카테고리만 그려 둠
  $materialsGrid.innerHTML = ''; // 빈 상태
  $materialsEmpty.classList.add('hidden');
  openSitePicker();              // ← 목록 띄우기
 renderCategoriesMobile('타일');   // ★ 모바일 칩도 초기 렌더
} else {
  // 뷰어: 기존처럼 바로 로딩
  await loadAllForSite(SiteState.currentId);
  renderMaterials('타일');
  renderProgress();
  renderUsers();
renderCategoriesMobile('타일');   // ★ 모바일 칩도 초기 렌더
}
// === [SITE BOOT] 끝 ===

// 관리자면 현장 +추가/현장관리 버튼 노출
$btnSiteAdd?.classList.toggle('hidden', Session.role !== 'admin');
$btnManageSites?.classList.toggle('hidden', Session.role !== 'admin');

    // 추가 버튼들
    on($btnAddMaterial,'click', ()=>{
      $matTitle.value=''; $matName.value=''; $matFile.value=''; $materialMsg.textContent=''; openModal($modalMaterial);
    });
    on($btnMaterialSave,'click', async ()=>{
      const category=$catTitle.textContent.trim();
      const title=$matTitle.value.trim(), name=$matName.value.trim(), file=$matFile.files?.[0]||null;
      if(!title||!name||!file){ $materialMsg.textContent='제목, 이름, 이미지를 모두 입력하세요.'; return; }
      let imgUrl=await uploadImage(file);
      const res=await api('save_material',{ siteId: SiteState.currentId, category, title, name, imgUrl }).catch(()=>null);
      if(res?.ok){ closeModal($modalMaterial); toast('추가됨'); await loadAll(); renderMaterials(category); }
      else $materialMsg.textContent='저장 실패';
    });

    on($btnAddProgressPhoto,'click', ()=>{ $proTitle.value=''; $proName.value=''; $proFile.value=''; $progressMsg.textContent=''; openModal($modalProgress); });
    on($btnProgressSave,'click', async ()=>{
      const title=$proTitle.value.trim(), name=$proName.value.trim(), file=$proFile.files?.[0]||null;
      if(!title||!name||!file){ $progressMsg.textContent='제목, 이름, 사진을 모두 입력하세요.'; return; }
      let imgUrl=await uploadImage(file);
      const res=await api('progress_upload',{ siteId: SiteState.currentId, title, name, imgUrl }).catch(()=>null);
      if(res?.ok){ closeModal($modalProgress); toast('업로드 완료'); await loadAll(); renderProgress(); }
      else $progressMsg.textContent='업로드 실패';
    });

    on($btnSaveNote,'click', async ()=>{
  const text = $miscNote.value;
  const key  = getActiveNoteKey(); // ★ 진행사항이면 '__progress__'
  const res  = await api('save_note',{ siteId: SiteState.currentId, category: key, text }).catch(()=>null);
  if(res?.ok){ $noteSaved.textContent='저장됨'; setTimeout(()=> $noteSaved.textContent='',1500); }
});
}

// HTML 특수문자 이스케이프
const htmlEsc = (s)=>String(s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
const cssId   = (s)=> String(s||'').replace(/[^\w-]/g, '_');

// 관리자: 사용자/현장 권한 로드
async function adminLoadUsersAndPerms() {
 const [sitesRes, allRes, grantsRes] = await Promise.all([
   api('list_sites',      {}),
    api('get_all',         {}),            // 관리자일 때 users 포함
    api('list_user_sites', {}),
  ]);

  if (!sitesRes?.ok)  return toast(sitesRes?.msg || '현장 목록 로드 실패');
  if (!allRes?.ok)    return toast(allRes?.msg   || '가입자 목록 로드 실패');
  if (!grantsRes?.ok) return toast(grantsRes?.msg|| '권한 목록 로드 실패');

  const sites  = sitesRes.sites || [];        // [{id,name,...}]
  const users  = allRes.users   || [];        // [{id, created, ...}]
  const grants = grantsRes.userSites || [];   // [{userId, siteId, role, grantedAt}]

  const grantsMap = new Map();
  grants.forEach(g => {
    if (!grantsMap.has(g.userId)) grantsMap.set(g.userId, []);
    grantsMap.get(g.userId).push({ siteId: g.siteId, role: g.role });
  });

  renderAdminUsersTable(users, sites, grantsMap);
}

// 관리자: Users 테이블 렌더
function renderAdminUsersTable(users, sites, grantsMap) {
  const tbody = document.getElementById('adminUsersBody');
  if (!tbody) return;
  tbody.innerHTML = '';

 users.forEach(u => {
  const userId = String(u.id);
  const userGrants = grantsMap.get(userId) || [];
  const candidateSites = sites.filter(s => !userGrants.some(g => g.siteId === s.id));

  const tr = document.createElement('tr');

const createdAbs  = u.created   ? formatKSTDateTime(u.created)   : '';
const createdDate = u.created   ? formatKSTDate(u.created)       : '';
  const lastRaw    = u.lastLogin || '';
  const lastAbs    = lastRaw     ? formatKSTDateTime(lastRaw)     : '';
  const lastHuman  = lastRaw     ? formatLastSeenKR(lastRaw)      : '—';

  tr.innerHTML = `
    <td>${htmlEsc(userId)}</td>
    <td title="${htmlEsc(createdAbs)}">${htmlEsc(createdDate || '')}</td>    <!-- 가입일 -->
    <td title="${htmlEsc(lastAbs)}">${htmlEsc(lastHuman)}</td>             <!-- 최종접속(상대) -->
    <td>
      <div class="site-tags" id="tags-${cssId(userId)}">
        ${userGrants.map(g => {
          const site = sites.find(s => s.id === g.siteId);
          const label = site?.name || g.siteId;
          return `<span class="site-tag" data-site="${htmlEsc(g.siteId)}">
                    ${htmlEsc(label)}
                    <button title="권한 해제" class="tag-x" data-user="${htmlEsc(userId)}" data-site="${htmlEsc(g.siteId)}">×</button>
                  </span>`;
        }).join('')}
      </div>
    </td>
    <td>
      <div class="grant-row">
        <select id="sel-${cssId(userId)}" class="grant-sel">
          <option value="">현장 선택</option>
          ${candidateSites.map(s => `<option value="${htmlEsc(s.id)}">${htmlEsc(s.name || s.id)}</option>`).join('')}
        </select>
        <button class="grant-btn" data-user="${htmlEsc(userId)}">권한 부여</button>
      </div>
    </td>
  `;
  tbody.appendChild(tr);
});

  // 빈 상태 표시
  if (typeof $usersEmpty !== 'undefined') {
    $usersEmpty.classList.toggle('hidden', (users.length > 0));
  }

  // 권한 부여
  tbody.querySelectorAll('.grant-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const userId = e.currentTarget.dataset.user;
      const sel    = document.getElementById(`sel-${cssId(userId)}`);
      const siteId = sel && sel.value;
      if (!siteId) return toast('현장을 선택하세요.');
      const r = await api('site_grant', { userId, siteId, role: 'viewer' });
      if (!r?.ok) return toast(r?.msg || '권한 부여 실패');
      await adminLoadUsersAndPerms();
      toast('권한을 부여했어요.');
    });
  });

  // 권한 해제
  tbody.querySelectorAll('.tag-x').forEach(x => {
    x.addEventListener('click', async (e) => {
      const userId = e.currentTarget.dataset.user;
      const siteId = e.currentTarget.dataset.site;
      const r = await api('site_revoke', { userId, siteId });
      if (!r?.ok) return toast(r?.msg || '권한 해제 실패');
      await adminLoadUsersAndPerms();
      toast('권한을 해제했어요.');
    });
  });
}

function getActiveCategory(){
  return ($catTitle?.textContent || '타일').trim();
}

function getActiveNoteKey(){
  // 탭이 진행사항이면 고정 키 사용, 아니면 현재 카테고리 사용
  const active = document.querySelector('.tab.active')?.dataset.tab;
  if (active === 'progress') return '__progress__';   // ★ 진행사항 전용 키
  return (window.currentCategory || getActiveCategory() || '타일');
}

// === Notes: 현장+카테고리 메모 로딩 ===
async function loadNoteForCurrentCategory(){
  const token  = Session.token;
  const siteId = (SiteState?.currentId || '');
  const key    = getActiveNoteKey();   // ★ 탭 기준 키
  if (!token || !siteId) return;

  // 1) 캐시 우선
  const cached = noteCacheGet(siteId, key);
  if (cached) {
    $miscNote.value = String(cached.text || '');
    const isAdmin = (Session.role === 'admin');
    $miscNote.disabled = !isAdmin;
    $btnSaveNote.classList.toggle('hidden', !isAdmin);

    // 최신화는 백그라운드
    apiSilent('load_note', { token, siteId, category: key }).then(res=>{
      if (res?.ok) {
        noteCachePut(siteId, key, res.text || '');
        // 아직 같은 탭/사이트면 화면 반영
        const nowKey = getActiveNoteKey();
        if (nowKey === key && (SiteState?.currentId) === siteId) {
          $miscNote.value = String(res.text || '');
        }
      }
    }).catch(()=>{});
    return;
  }

  // 2) 캐시 없으면 1회 요청
  const res = await apiSilent('load_note', { token, siteId, category: key }).catch(()=>null);
  if (res?.ok) {
    noteCachePut(siteId, key, res.text || '');
    $miscNote.value = String(res.text || '');
    const isAdmin = (Session.role === 'admin');
    $miscNote.disabled = !isAdmin;
    $btnSaveNote.classList.toggle('hidden', !isAdmin);
  } else {
    // 초기 상태 클리어
    $miscNote.value = '';
    const isAdmin = (Session.role === 'admin');
    $miscNote.disabled = !isAdmin;
    $btnSaveNote.classList.toggle('hidden', !isAdmin);
  }
}

window.addEventListener('resize', () => {
  const cat = (window.currentCategory || getActiveCategory() || '타일');
  renderCategoriesMobile(cat);
});

/* ===== Disable Pull-To-Refresh on mobile (iOS/Android) ===== */
(function setupDisablePTR(){
  // 모바일에서만 동작
  function isMobile(){ return window.matchMedia('(max-width: 720px)').matches; }

  const root = document.scrollingElement || document.documentElement;
  let startY = 0;
  let maybePull = false;

  // 터치 시작점 기록
  document.addEventListener('touchstart', (e) => {
    if (!isMobile() || e.touches.length !== 1) return;
    startY = e.touches[0].clientY;
    // 문서 스크롤이 꼭대기일 때만 "아래로 끌어내리는 제스처" 감시
    maybePull = (root.scrollTop <= 0);
  }, { passive: true });

  // 아래로 끌어내리면 기본 동작(새로고침 바운스)을 막음
  document.addEventListener('touchmove', (e) => {
    if (!isMobile() || !maybePull) return;

    const dy = e.touches[0].clientY - startY;
    if (dy > 0) {
      // 입력 필드/스크롤 가능한 내부 영역은 예외 처리
      const t = e.target;
      const isInsideScrollable =
        t.closest('.modal .bd, .grid, .main, textarea, input, select');
      if (!isInsideScrollable) {
        e.preventDefault();            // ★ iOS PTR 차단 핵심
      }
    }
  }, { passive: false });              // ★ 반드시 non-passive
})();

  </script>
</body>
</html>
